# Техническая документация Symbiochi

## 1. Обзор проекта
Symbiochi — браузерная игра-тамагочи с процедурной эволюцией. Приложение не требует сборки и запускается напрямую в браузере через `index.html`. Архитектура модульная: рендер, симуляция, состояние и UI разделены по файлам в `js/`.

## 2. Быстрый старт
1. Откройте `index.html` в браузере.
2. Нажмите «ИГРАТЬ!», чтобы загрузить состояние и запустить циклы симуляции.

> Проект использует только HTML/CSS/JS (ES modules), локальное состояние хранится в `localStorage`.

## 3. Структура проекта
- `index.html` — разметка UI, модальные окна, вкладки, канвас.
- `styles.css` — визуальный стиль.
- `js/main.js` — точка входа, инициализация, цикл рендера и автосимуляции.
- `js/state.js` — состояние, симуляция, миграции, сохранения.
- `js/state_mutation.js` — мутации, экология, почкование, симбиоз.
- `js/creature.js` — генерация организма и рост тела.
- `js/render.js` — канвас-рендерер (пиксельные блоки, эффекты).
- `js/ui.js` — обработчики UI, лог, настройки, симбиоз.
- `js/mods/*` — правила, константы, палитры, органы, цвета.

## 4. Архитектура и поток выполнения

### 4.1 Инициализация
- `main.js` собирает ссылки на DOM-элементы, создаёт объект `view` и тост-уведомления.
- Состояние загружается через `migrateOrNew()` (либо создаётся новое, либо нормализуется старое).
- После нажатия «ИГРАТЬ!» запускаются два цикла:
  - `render` через `requestAnimationFrame`.
  - `autoTick` через `setInterval` (шаг симуляции).

### 4.2 Рендер-цикл
- `renderGrid()` отрисовывает организм на канвасе и обновляет перф-статистику.
- При смене активного организма (родитель/почка) запускается `rerenderAll()` с пересборкой HUD, легенды и лога.
- Рендер не изменяет состояние — он использует `view.state` только на чтение.

### 4.3 Симуляция (autoTick)
- `autoTick()` вычисляет `deltaSec` по времени последней активности.
- `simulate(state, deltaSec)`:
  - Применяет затухание баров (еда/чистота/настроение/HP).
  - Рассчитывает стресс и накопление «запущенности».
  - Определяет, сколько «эволюционных тиков» нужно обработать (онлайн/оффлайн).
  - Выполняет мутации и рост через `applyMutation()`.
  - Обновляет состояние и лог.
- После симуляции состояние сохраняется в `localStorage`.

## 5. Модель данных состояния
Состояние (`state`) — главный объект, который сериализуется в `localStorage`.

### 5.1 Основные поля
- `seed` — базовый сид для детерминизма.
- `createdAt`, `lastSeen`, `lastMutationAt` — таймстемпы (сек).
- `evoIntervalMin` — интервал мутаций.
- `bars` — параметры здоровья (`food`, `clean`, `hp`, `mood`).
- `care` — история ухода (`feed`, `wash`, `heal`, `neglect`).
- `body` — базовое тело (`core`, `cells`).
- `modules` — органы/отростки (массив модулей с типом, клетками, признаком подвижности и т.д.).
- `buds` — массив «почек» (самостоятельные существа с таким же форматом, как родитель).
- `palette`, `partColor`, `partHue` — цвета тела и органов.
- `growthTarget*` — цель роста (используется системой морковок).
- `cam` — позиция камеры относительно ядра тела.
- `log` — журнал событий.

### 5.2 Миграции и нормализация
Функция `migrateOrNew()`:
- Поддерживает обратную совместимость состояния (версия 6).
- Нормализует тело и модули (валидирует клетки, ограничивает длины, исключает пересечения).
- Гарантирует наличие планов развития (`plan`) и косметических параметров лица.

## 6. Эволюция, рост и экология

### 6.1 Рост тела
- `makeSmallConnectedBody()` создаёт стартовый связный «ком» клеток.
- `growBodyConnected()` добавляет клетки с учётом:
  - «плана» организма (`axisDir`, `symmetry`, `wiggle`, `ecotype`),
  - направления морковки (целевого роста),
  - ограничений связности.

### 6.2 Мутации
- Логика мутаций реализована в `state_mutation.js`.
- Вес мутаций зависит от:
  - стиля ухода,
  - морфологии (мобильность/защита/сенсорика/размер),
  - текущего стресса.
- Мутации могут добавлять/удлинять органы, менять морфологию и параметры.

### 6.3 Почкование
- Подвижные длинные модули (например, хвосты или щупальца) могут стать «почкой».
- Алгоритм:
  1. Выбирается длинный подвижный модуль.
  2. Отрезается сегмент ≥ 4 клеток.
  3. Создаётся базовое тело, совмещённое с началом сегмента.
  4. Новая особь добавляется в `state.buds`.

### 6.4 Морковки (growth target)
- Режим кормления позволяет «поставить» морковку (форма 3×7) на поле.
- Близость морковки управляет приоритетом роста тела/отростков через `growthTarget` и `growthTargetMode`.

## 7. Рендеринг

### 7.1 Канвас и сетка
- `render.js` рассчитывает размеры сетки и блоков по CSS-переменной `--cellSize`.
- Зум изменяет размер блока (масштабирование без изменения мировых координат).

### 7.2 Визуальные эффекты
- Дыхание: вертикальная синусоидальная анимация.
- Рост: новые клетки экструдируются в течение 0.7 сек.
- Подсветка активного организма — «кристальный» внешний контур.
- Органы окрашиваются по палитрам, оттенок можно смещать (Hue Shift).

## 8. UI и взаимодействие

### 8.1 Основные элементы UI
- HUD: имя, стадия, состояние баров, запасы морковок.
- Панель управления: кормить / мыть / лечить.
- Информационные вкладки: организм, легенда, журнал, правила.
- Настройки: сид, интервал мутаций, приоритет длины отростков, запас морковок.

### 8.2 Управление
- Клик по организму — выбор родителя/почки.
- Drag по полю — панорамирование камеры.
- Колесо мыши / pinch — зум.
- Клик в режиме «КОРМИТЬ» — постановка морковки.

### 8.3 Симбиоз (обмен геномом)
- В UI можно скопировать код генома текущего организма.
- Геном сериализуется и может быть применён к другому состоянию.
- `applySymbiosisMerge()` объединяет два генома и заменяет тело выбранным результатом.

## 9. Хранение и персистентность
- Данные сериализуются в `localStorage` под ключом `symbiochi_v6_save`.
- Сохранение вызывается после каждого шага симуляции и при изменении настроек.

## 10. Расширение проекта

### 10.1 Добавление нового органа
1. Создать модуль в `js/organs/`.
2. Подключить в `creature.js`.
3. Добавить метки и цвета при необходимости (`mods/labels.js`, `mods/colors.js`).

### 10.2 Изменение правил эволюции
- Основная логика — `state_mutation.js`.
- Параметры баланса — в `js/mods/*` (например, `mods/evo.js`).

### 10.3 Изменение рендера
- Все визуальные эффекты и палитры находятся в `render.js` и `mods/colors.js`.
- CSS-переменная `--cellSize` задаёт базовый размер клетки.

## 11. Ограничения и особенности
- Нет серверной части: всё работает локально в браузере.
- Производительность зависит от размера организма и числа модулей.
- Оффлайн-прогресс симулируется при следующем запуске (по дельте времени).

