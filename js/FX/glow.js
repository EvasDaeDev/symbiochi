// js/FX/glow.js
// Периметральный Glow для пиксельарта (без тяжёлого blur в несколько проходов).
//
// Идея:
//  - Glow рисуется СНАРУЖИ организма, вдоль его периметра.
//  - Цвет берётся из ближайших "внутренних" пикселей (цвет блоков тела/органов),
//    поэтому свечение наследует и смешивает цвета.
//  - Длина свечения разбита на 3 зоны (градации) по насыщенности/интенсивности.
//    Точки градации можно сдвигать (band1, band2).
//
// Важно:
//  - Это view-only: шейдер делает всё по экранному кадру (uScene).
//  - Фон в Symbiochi тёмный, поэтому "внутреннее" определяется по порогу яркости (bgLumaCut).

function clamp01(v){
  v = +v;
  if (!Number.isFinite(v)) return 0;
  return Math.max(0, Math.min(1, v));
}

export const GLOW_DEFAULTS = {
  // Общая сила свечения (множитель).
  strength: 0.90,

  // Радиус (длина) свечения в пикселях. Фактически это "макс-дальность" (outer band).
  radiusPx: 15.0,

  // Порог яркости фона (0..1). Всё что ниже — считаем фоном, всё что выше — "организм".
  // Если фон очень тёмный — 0.10..0.18, если фон светлее — подними.
  bgLumaCut: 0.24,

  // --- 3 градации по длине ---
  // band1 / band2 — точки разбиения по длине (доли от radiusPx).
  // Пример: band1=0.35, band2=0.70 => 0..35% (inner), 35..70% (mid), 70..100% (outer)
  band1: 0.05,
  band2: 0.50,

  // Интенсивность/насыщенность по зонам (внутренняя самая сильная).
  // Эти веса умножаются на strength и на "маску периметра".
  w1: 0.90,
  w2: 0.70,
  w3: 0.15,

  // Мягкость края кольца (0..1): 0 жёстко, 1 мягко.
  soft: 0.00,

  // Влияние сытости: когда еда высокая, glow мягче (уменьшаем силу).
  // food01 = food/BAR_MAX.
  foodSoftening: 0.20,
};

// Возвращает итоговую силу glow с учётом сытости.
export function computeGlowStrength(cfg, food01){
  const base = Number.isFinite(cfg?.strength) ? cfg.strength : GLOW_DEFAULTS.strength;
  const soften = Number.isFinite(cfg?.foodSoftening) ? cfg.foodSoftening : GLOW_DEFAULTS.foodSoftening;
  const k = 1.0 - soften * clamp01(food01);
  return Math.max(0, base * k);
}
